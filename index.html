<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arabiac</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" crossorigin="anonymous"></script>
    <style>
        /* ===== THEME VARIABLES ===== */
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-hover: #2a2a2a;
            --bg-active: #333333;
            --bg-floating: #1e1e1e;
            --accent: #c9a227;
            --accent-hover: #dbb833;
            --accent-dim: rgba(201,162,39,0.15);
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --text-muted: #606060;
            --border: #2d2d2d;
            --online: #43b581;
            --idle: #faa61a;
            --dnd: #f04747;
            --mention-bg: rgba(201,162,39,0.12);
            --scrollbar-thumb: #404040;
            --scrollbar-track: transparent;
        }

        /* ===== RESET ===== */
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* ===== LOGIN ===== */
        .login-screen {
            position: fixed; inset: 0;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-primary);
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        .login-bg {
            position: absolute; inset: 0;
            background: radial-gradient(ellipse at 30% 50%, rgba(201,162,39,0.08) 0%, transparent 60%),
                        radial-gradient(ellipse at 70% 80%, rgba(201,162,39,0.05) 0%, transparent 50%);
        }
        .login-card {
            position: relative; background: var(--bg-secondary);
            border: 1px solid var(--border); border-radius: 12px;
            padding: 40px; width: 420px; max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .login-logo { text-align: center; margin-bottom: 30px; }
        .login-logo h1 {
            font-size: 36px; font-weight: 700; color: var(--accent);
            letter-spacing: 2px;
        }
        .login-logo p { color: var(--text-secondary); font-size: 14px; margin-top: 6px; }
        .form-field { margin-bottom: 18px; }
        .form-field label {
            display: block; font-size: 12px; font-weight: 600;
            color: var(--text-secondary); margin-bottom: 6px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .form-field input {
            width: 100%; padding: 10px 14px; font-size: 14px;
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text-primary);
            font-family: inherit; outline: none; transition: border 0.2s;
        }
        .form-field input:focus { border-color: var(--accent); }
        .form-field input[type="color"] {
            width: 50px; height: 36px; padding: 2px; cursor: pointer;
            border-radius: 6px;
        }
        .login-buttons { display: flex; gap: 10px; margin-top: 24px; }
        .btn {
            padding: 10px 20px; font-size: 14px; font-weight: 600;
            border: none; border-radius: 6px; cursor: pointer;
            font-family: inherit; transition: all 0.2s;
        }
        .btn-primary {
            background: var(--accent); color: #000; flex: 1;
        }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary {
            background: transparent; color: var(--text-secondary);
            border: 1px solid var(--border); flex: 1;
        }
        .btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .btn-danger { background: var(--dnd); color: #fff; }
        .login-footer {
            text-align: center; margin-top: 20px;
            font-size: 12px; color: var(--text-muted); line-height: 1.6;
        }

        /* ===== APP LAYOUT ===== */
        .app { display: none; height: 100vh; }
        .app.active { display: flex; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 240px; background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-header {
            padding: 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
        }
        .sidebar-header h2 {
            font-size: 18px; font-weight: 700; color: var(--accent);
            letter-spacing: 1px;
        }
        .sidebar-header .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--online); flex-shrink: 0;
        }
        .channels { flex: 1; overflow-y: auto; padding: 8px 0; }
        .channel-category {
            padding: 8px 16px; font-size: 11px; font-weight: 700;
            color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .channel {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px; margin: 1px 8px; border-radius: 6px;
            cursor: pointer; color: var(--text-secondary);
            font-size: 14px; font-weight: 500; transition: all 0.15s;
        }
        .channel:hover { background: var(--bg-hover); color: var(--text-primary); }
        .channel.active {
            background: var(--accent-dim); color: var(--accent);
        }
        .channel .hash { font-size: 18px; font-weight: 400; opacity: 0.6; }

        .user-panel {
            padding: 10px; border-top: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
            background: var(--bg-tertiary);
        }
        .user-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px; color: #000; flex-shrink: 0;
        }
        .user-panel-info { flex: 1; min-width: 0; }
        .user-panel-name {
            font-size: 13px; font-weight: 600; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .user-panel-status { font-size: 11px; color: var(--text-muted); }
        .settings-btn {
            width: 32px; height: 32px; border-radius: 6px;
            background: transparent; border: none; color: var(--text-secondary);
            cursor: pointer; font-size: 16px; display: flex;
            align-items: center; justify-content: center; transition: all 0.15s;
        }
        .settings-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* ===== MAIN CHAT ===== */
        .main-chat { flex: 1; display: flex; flex-direction: column; min-width: 0; }

        .chat-header {
            height: 48px; padding: 0 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px; flex-shrink: 0;
        }
        .chat-header .hash { font-size: 22px; color: var(--text-muted); font-weight: 300; }
        .chat-header .channel-name { font-size: 15px; font-weight: 700; }
        .chat-header .divider {
            width: 1px; height: 20px; background: var(--border); margin: 0 6px;
        }
        .chat-header .channel-topic {
            font-size: 13px; color: var(--text-muted); flex: 1;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .header-actions { display: flex; gap: 4px; }
        .header-actions button {
            width: 32px; height: 32px; border-radius: 6px;
            background: transparent; border: none; color: var(--text-secondary);
            cursor: pointer; font-size: 16px; transition: all 0.15s;
        }
        .header-actions button:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* ===== MESSAGES ===== */
        .messages-container {
            flex: 1; overflow-y: auto; padding: 16px 0;
        }
        .message {
            padding: 4px 16px; display: flex; gap: 12px;
            transition: background 0.1s;
        }
        .message:hover { background: var(--bg-hover); }
        .message + .message { margin-top: 2px; }
        .message-new-group { margin-top: 16px; }
        .msg-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 15px; color: #000; flex-shrink: 0;
            margin-top: 2px;
        }
        .msg-body { flex: 1; min-width: 0; }
        .msg-header { display: flex; align-items: baseline; gap: 8px; }
        .msg-author { font-size: 14px; font-weight: 600; cursor: pointer; }
        .msg-author:hover { text-decoration: underline; }
        .msg-time { font-size: 11px; color: var(--text-muted); }
        .msg-text {
            font-size: 14px; color: var(--text-primary);
            line-height: 1.5; margin-top: 2px; word-wrap: break-word;
        }
        .msg-text .mention {
            background: var(--mention-bg); color: var(--accent);
            padding: 0 3px; border-radius: 3px; font-weight: 600;
        }
        .msg-image {
            max-width: 400px; max-height: 300px; border-radius: 8px;
            margin-top: 6px; cursor: pointer; transition: opacity 0.2s;
        }
        .msg-image:hover { opacity: 0.9; }
        .msg-reactions { display: flex; gap: 4px; margin-top: 4px; }
        .reaction-chip {
            padding: 2px 8px; border-radius: 12px; font-size: 12px;
            background: var(--bg-tertiary); border: 1px solid var(--border);
            cursor: pointer; transition: all 0.15s; color: var(--text-secondary);
        }
        .reaction-chip:hover { border-color: var(--accent); background: var(--accent-dim); }
        .msg-system {
            padding: 4px 16px; display: flex; align-items: center; gap: 8px;
        }
        .msg-system-text {
            font-size: 13px; color: var(--text-muted); font-style: italic;
        }
        .msg-system-dot {
            width: 4px; height: 4px; border-radius: 50%;
            background: var(--text-muted); flex-shrink: 0;
        }
        .msg-action {
            padding: 4px 16px; font-size: 14px; color: var(--text-secondary);
            font-style: italic;
        }
        .msg-error {
            padding: 4px 16px; font-size: 13px; color: var(--dnd);
            display: flex; align-items: center; gap: 6px;
        }

        .typing-indicator {
            height: 24px; padding: 0 16px; font-size: 12px;
            color: var(--text-muted); display: flex; align-items: center;
            flex-shrink: 0;
        }

        /* ===== INPUT ===== */
        .input-area {
            padding: 0 16px 20px; flex-shrink: 0;
        }
        .input-wrapper {
            display: flex; align-items: center; gap: 0;
            background: var(--bg-tertiary); border-radius: 8px;
            border: 1px solid var(--border); transition: border 0.2s;
        }
        .input-wrapper:focus-within { border-color: var(--accent); }
        .upload-btn {
            width: 44px; height: 44px; background: transparent;
            border: none; color: var(--text-muted); font-size: 22px;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; border-radius: 8px 0 0 8px; transition: color 0.15s;
        }
        .upload-btn:hover { color: var(--accent); }
        .msg-input {
            flex: 1; padding: 10px 0; font-size: 14px;
            background: transparent; border: none; color: var(--text-primary);
            font-family: inherit; outline: none;
        }
        .msg-input::placeholder { color: var(--text-muted); }
        .send-btn {
            width: 44px; height: 44px; background: transparent;
            border: none; color: var(--accent); font-size: 18px;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; border-radius: 0 8px 8px 0; transition: all 0.15s;
        }
        .send-btn:hover { background: var(--accent-dim); }

        /* ===== MEMBERS SIDEBAR ===== */
        .members-sidebar {
            width: 240px; background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            overflow-y: auto; flex-shrink: 0; padding: 16px 8px;
        }
        .members-sidebar.hidden { display: none; }
        .members-category {
            padding: 8px 8px 4px; font-size: 11px; font-weight: 700;
            color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .member-item {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 8px; border-radius: 6px; cursor: pointer;
            transition: background 0.15s;
        }
        .member-item:hover { background: var(--bg-hover); }
        .member-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 12px; color: #000;
            position: relative; flex-shrink: 0;
        }
        .member-status-dot {
            position: absolute; bottom: -1px; right: -1px;
            width: 10px; height: 10px; border-radius: 50%;
            border: 2px solid var(--bg-secondary);
        }
        .member-name {
            font-size: 13px; font-weight: 500; color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center;
            z-index: 5000; animation: fadeIn 0.15s;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-secondary); border-radius: 12px;
            border: 1px solid var(--border); width: 600px;
            max-width: 90vw; max-height: 80vh; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 16px 20px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-header h3 { font-size: 18px; font-weight: 700; }
        .modal-close {
            width: 32px; height: 32px; border-radius: 50%; background: transparent;
            border: none; color: var(--text-secondary); font-size: 18px;
            cursor: pointer; transition: all 0.15s;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .modal-tabs {
            display: flex; border-bottom: 1px solid var(--border);
            padding: 0 20px; gap: 0;
        }
        .modal-tab {
            padding: 12px 16px; font-size: 13px; font-weight: 600;
            color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }
        .modal-tab:hover { color: var(--text-secondary); }
        .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .setting-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .setting-row:last-child { border-bottom: none; }
        .setting-label { font-size: 14px; font-weight: 500; }
        .setting-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .setting-row select, .setting-row input[type="color"] {
            background: var(--bg-tertiary); border: 1px solid var(--border);
            color: var(--text-primary); padding: 6px 10px; border-radius: 6px;
            font-family: inherit; font-size: 13px; cursor: pointer;
        }
        .setting-row input[type="color"] { width: 44px; height: 32px; padding: 2px; }
        .setting-row input[type="checkbox"] {
            width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer;
        }

        /* Theme Grid */
        .theme-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 10px; margin-top: 12px;
        }
        .theme-card {
            padding: 12px; border-radius: 8px; border: 2px solid var(--border);
            cursor: pointer; transition: all 0.15s; text-align: center;
        }
        .theme-card:hover { border-color: var(--text-muted); }
        .theme-card.active { border-color: var(--accent); }
        .theme-preview {
            height: 40px; border-radius: 4px; margin-bottom: 8px;
            display: flex; overflow: hidden;
        }
        .theme-preview div { flex: 1; }
        .theme-card-name { font-size: 12px; font-weight: 600; }

        /* Achievements */
        .ach-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px; margin-bottom: 8px; border-radius: 8px;
            background: var(--bg-tertiary); border: 1px solid var(--border);
        }
        .ach-item.locked { opacity: 0.4; }
        .ach-icon { font-size: 28px; }
        .ach-info { flex: 1; }
        .ach-title { font-size: 14px; font-weight: 600; }
        .ach-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

        /* ===== PM MODAL ===== */
        .pm-modal { width: 440px; }
        .pm-messages {
            height: 250px; overflow-y: auto; padding: 12px;
            background: var(--bg-primary); border-radius: 8px;
            margin-bottom: 12px;
        }
        .pm-msg { margin-bottom: 8px; font-size: 13px; }
        .pm-input-row { display: flex; gap: 8px; }
        .pm-input-row input {
            flex: 1; padding: 10px; font-size: 13px;
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: 6px; color: var(--text-primary);
            font-family: inherit; outline: none;
        }
        .pm-input-row input:focus { border-color: var(--accent); }

        /* ===== TOASTS ===== */
        .toast-container {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 8px; z-index: 8000;
        }
        .toast {
            background: var(--bg-floating); border: 1px solid var(--border);
            border-left: 3px solid var(--accent); border-radius: 6px;
            padding: 12px 16px; min-width: 280px; max-width: 360px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            animation: slideUp 0.3s ease; font-size: 13px;
        }
        .toast-title { font-weight: 600; margin-bottom: 4px; font-size: 12px; color: var(--accent); }
        .toast-text { color: var(--text-secondary); }
        .toast-achievement {
            border-left-color: #ffd700;
            background: linear-gradient(135deg, var(--bg-floating), rgba(201,162,39,0.1));
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes slideUp { from { transform:translateY(20px);opacity:0; } to { transform:translateY(0);opacity:1; } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            .members-sidebar { display: none; }
        }
        @media (max-width: 600px) {
            .sidebar { width: 60px; }
            .sidebar-header h2, .channel-category, .channel span,
            .user-panel-info { display: none; }
            .channel { justify-content: center; padding: 10px; margin: 2px 4px; }
            .user-panel { justify-content: center; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- ===== LOGIN ===== -->
    <div class="login-screen" id="loginScreen">
        <div class="login-bg"></div>
        <div class="login-card">
            <div class="login-logo">
                <h1>ARABIAC</h1>
                <p>Welcome back! Let's get chatting.</p>
            </div>
            <div class="form-field">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter your username" maxlength="20">
            </div>
            <div class="form-field">
                <label>Password <span style="font-weight:400;text-transform:none">(optional ‚Äî for saving account)</span></label>
                <input type="password" id="loginPassword" placeholder="Leave blank for guest mode">
            </div>
            <div class="form-field">
                <label>Display Color</label>
                <input type="color" id="loginColor" value="#c9a227">
            </div>
            <div class="login-buttons">
                <button class="btn btn-primary" onclick="doLogin(false)">Login / Register</button>
                <button class="btn btn-secondary" onclick="doLogin(true)">Guest</button>
            </div>
            <div class="login-footer">
                <strong>Registered:</strong> saves achievements & settings<br>
                <strong>Guest:</strong> instant access, no saving
            </div>
        </div>
    </div>

    <!-- ===== APP ===== -->
    <div class="app" id="app">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="status-dot" id="connDot"></div>
                <h2>ARABIAC</h2>
            </div>
            <div class="channels">
                <div class="channel-category">Text Channels</div>
                <div class="channel active" data-room="general" onclick="switchRoom('general')">
                    <span class="hash">#</span><span>general</span>
                </div>
                <div class="channel" data-room="random" onclick="switchRoom('random')">
                    <span class="hash">#</span><span>random</span>
                </div>
                <div class="channel" data-room="media" onclick="switchRoom('media')">
                    <span class="hash">#</span><span>media</span>
                </div>
                <div class="channel" data-room="lounge" onclick="switchRoom('lounge')">
                    <span class="hash">#</span><span>lounge</span>
                </div>
            </div>
            <div class="user-panel">
                <div class="user-avatar" id="myAvatar" style="background:var(--accent);">?</div>
                <div class="user-panel-info">
                    <div class="user-panel-name" id="myName">...</div>
                    <div class="user-panel-status" id="myStatus">Online</div>
                </div>
                <button class="settings-btn" onclick="openSettings()" title="Settings">‚öô</button>
            </div>
        </div>

        <!-- MAIN CHAT -->
        <div class="main-chat">
            <div class="chat-header">
                <span class="hash">#</span>
                <span class="channel-name" id="headerChannel">general</span>
                <span class="divider"></span>
                <span class="channel-topic" id="headerTopic">General discussion</span>
                <div class="header-actions">
                    <button onclick="toggleMembers()" title="Members">üë•</button>
                    <button onclick="downloadLog()" title="Download Log">üíæ</button>
                </div>
            </div>
            <div class="messages-container" id="messagesArea"></div>
            <div class="typing-indicator" id="typingIndicator"></div>
            <div class="input-area">
                <div class="input-wrapper">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Upload Image">+</button>
                    <input type="file" id="fileInput" accept="image/*" style="display:none">
                    <input type="text" class="msg-input" id="msgInput" placeholder="Message #general" maxlength="500" autocomplete="off">
                    <button class="send-btn" onclick="sendMessage()" title="Send">‚û§</button>
                </div>
            </div>
        </div>

        <!-- MEMBERS -->
        <div class="members-sidebar" id="membersSidebar">
            <div id="membersList"></div>
        </div>
    </div>

    <!-- ===== SETTINGS MODAL ===== -->
    <div class="modal-overlay" id="settingsOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('profile')">Profile</div>
                <div class="modal-tab" onclick="switchTab('themes')">Themes</div>
                <div class="modal-tab" onclick="switchTab('notifs')">Notifications</div>
                <div class="modal-tab" onclick="switchTab('achievements')">Achievements</div>
                <div class="modal-tab" onclick="switchTab('help')">Help</div>
            </div>
            <div class="modal-body">
                <!-- PROFILE -->
                <div class="tab-content active" id="tab-profile">
                    <div class="setting-row">
                        <div><div class="setting-label">Username</div></div>
                        <input type="text" id="setUsername" readonly style="background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-muted);padding:6px 10px;border-radius:6px;font-family:inherit;">
                    </div>
                    <div class="setting-row">
                        <div><div class="setting-label">Display Color</div></div>
                        <input type="color" id="setColor" value="#c9a227">
                    </div>
                    <div class="setting-row">
                        <div><div class="setting-label">Status</div></div>
                        <select id="setStatus">
                            <option value="Online">üü¢ Online</option>
                            <option value="Away">üü° Away</option>
                            <option value="Busy">üî¥ Busy</option>
                        </select>
                    </div>
                    <div style="margin-top:20px">
                        <button class="btn btn-primary" onclick="saveProfile()" style="width:100%">Save Profile</button>
                    </div>
                </div>
                <!-- THEMES -->
                <div class="tab-content" id="tab-themes">
                    <div class="setting-label" style="margin-bottom:12px;">Choose a Theme</div>
                    <div class="theme-grid" id="themeGrid"></div>
                    <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px;">
                        <div class="setting-label" style="margin-bottom:12px;">Custom Colors</div>
                        <div class="setting-row">
                            <div><div class="setting-label">Accent Color</div></div>
                            <input type="color" id="customAccent" value="#c9a227">
                        </div>
                        <div class="setting-row">
                            <div><div class="setting-label">Background</div></div>
                            <input type="color" id="customBg" value="#0d0d0d">
                        </div>
                        <div class="setting-row">
                            <div><div class="setting-label">Sidebar</div></div>
                            <input type="color" id="customSidebar" value="#1a1a1a">
                        </div>
                        <button class="btn btn-secondary" onclick="applyCustomTheme()" style="width:100%;margin-top:12px;">Apply Custom</button>
                    </div>
                </div>
                <!-- NOTIFICATIONS -->
                <div class="tab-content" id="tab-notifs">
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">Enable Notifications</div>
                            <div class="setting-desc">Show toast notifications for new messages</div>
                        </div>
                        <input type="checkbox" id="setNotifs" checked>
                    </div>
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">PM Notifications</div>
                            <div class="setting-desc">Show popup for private messages</div>
                        </div>
                        <input type="checkbox" id="setPmNotifs" checked>
                    </div>
                </div>
                <!-- ACHIEVEMENTS -->
                <div class="tab-content" id="tab-achievements">
                    <div id="achList"></div>
                </div>
                <!-- HELP -->
                <div class="tab-content" id="tab-help">
                    <h4 style="color:var(--accent);margin-bottom:12px;">Slash Commands</h4>
                    <div style="font-size:13px;line-height:2;color:var(--text-secondary);">
                        <code>/me &lt;action&gt;</code> ‚Äî Perform an action<br>
                        <code>/nick &lt;name&gt;</code> ‚Äî Change name (guests only)<br>
                        <code>/color #RRGGBB</code> ‚Äî Change display color<br>
                        <code>/clear</code> ‚Äî Clear your chat view<br>
                        <code>/status Online|Away|Busy</code> ‚Äî Set status<br>
                        <code>/join &lt;room&gt;</code> ‚Äî Switch rooms<br>
                        <code>/msg &lt;user&gt; &lt;text&gt;</code> ‚Äî Private message<br>
                        <code>/help</code> ‚Äî Show help in chat
                    </div>
                    <h4 style="color:var(--accent);margin:20px 0 12px;">Image Keywords</h4>
                    <div style="font-size:13px;line-height:2;color:var(--text-secondary);">
                        <code>!dog</code> <code>!cat</code> <code>!lol</code> <code>!cool</code> <code>!fire</code>
                    </div>
                    <h4 style="color:var(--accent);margin:20px 0 12px;">Tips</h4>
                    <div style="font-size:13px;line-height:2;color:var(--text-secondary);">
                        Press Enter to send ‚Ä¢ Double-click a user to PM ‚Ä¢ Use @username to mention ‚Ä¢ Upload images with the + button
                    </div>
                    <div style="margin-top:30px;padding-top:16px;border-top:1px solid var(--border);text-align:center;color:var(--text-muted);font-size:12px;">
                        Arabiac v1.0.0
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== PM MODAL ===== -->
    <div class="modal-overlay" id="pmOverlay">
        <div class="modal pm-modal">
            <div class="modal-header">
                <h3>PM ‚Äî <span id="pmTargetName">User</span></h3>
                <button class="modal-close" onclick="closePM()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="pm-messages" id="pmMessages"></div>
                <div class="pm-input-row">
                    <input type="text" id="pmInput" placeholder="Type a message..." autocomplete="off">
                    <button class="btn btn-primary btn-small" onclick="sendPM()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOASTS -->
    <div class="toast-container" id="toastContainer"></div>

<script>
// ======================== STATE ========================
let currentUser = '';
let userColor = '#c9a227';
let userStatus = 'Online';
let currentRoom = 'general';
let users = [];
let messageCount = 0;
let achievements = [];
let pmTarget = null;
let isGuest = false;
let typingTimeout;
let membersVisible = true;
let roomMessages = { general:'', random:'', media:'', lounge:'' };

const ROOM_TOPICS = {
    general: 'General discussion',
    random: 'Random stuff & fun',
    media: 'Share images & media',
    lounge: 'Chill & hang out'
};

const ALL_ACHIEVEMENTS = [
    { id:'first-message', title:'First Message', desc:'Sent your first message', icon:'üí¨' },
    { id:'chatty', title:'Chatty', desc:'Sent 10 messages', icon:'üó£Ô∏è' },
    { id:'super-chatty', title:'Super Chatty', desc:'Sent 50 messages', icon:'üì¢' },
    { id:'chatterbox', title:'Chatterbox', desc:'Sent 100 messages', icon:'üèÜ' },
    { id:'veteran', title:'Veteran', desc:'30 minutes online', icon:'‚è∞' },
    { id:'image-poster', title:'Picture Perfect', desc:'Posted an image', icon:'üì∏' },
    { id:'room-hopper', title:'Room Hopper', desc:'Visited all rooms', icon:'üö™' },
    { id:'socialite', title:'Socialite', desc:'Sent a private message', icon:'üíå' }
];

const THEMES = {
    'midnight-gold': {
        name:'Midnight Gold',
        colors:{ '--bg-primary':'#0d0d0d','--bg-secondary':'#1a1a1a','--bg-tertiary':'#252525','--bg-hover':'#2a2a2a','--bg-active':'#333','--bg-floating':'#1e1e1e','--accent':'#c9a227','--accent-hover':'#dbb833','--accent-dim':'rgba(201,162,39,0.15)','--text-primary':'#e8e8e8','--text-secondary':'#a0a0a0','--text-muted':'#606060','--border':'#2d2d2d','--mention-bg':'rgba(201,162,39,0.12)','--scrollbar-thumb':'#404040' },
        preview:['#0d0d0d','#1a1a1a','#c9a227']
    },
    'discord-dark': {
        name:'Discord Dark',
        colors:{ '--bg-primary':'#313338','--bg-secondary':'#2b2d31','--bg-tertiary':'#1e1f22','--bg-hover':'#3a3c41','--bg-active':'#43454a','--bg-floating':'#232428','--accent':'#5865f2','--accent-hover':'#4752c4','--accent-dim':'rgba(88,101,242,0.15)','--text-primary':'#dbdee1','--text-secondary':'#96989d','--text-muted':'#72767d','--border':'#3f4147','--mention-bg':'rgba(88,101,242,0.12)','--scrollbar-thumb':'#1a1b1e' },
        preview:['#313338','#2b2d31','#5865f2']
    },
    'royal-purple': {
        name:'Royal Purple',
        colors:{ '--bg-primary':'#1a0a2e','--bg-secondary':'#16082b','--bg-tertiary':'#2d1b4e','--bg-hover':'#341f57','--bg-active':'#3e2565','--bg-floating':'#1e0e35','--accent':'#a855f7','--accent-hover':'#c084fc','--accent-dim':'rgba(168,85,247,0.15)','--text-primary':'#e8e0f0','--text-secondary':'#a090b0','--text-muted':'#605070','--border':'#3d2860','--mention-bg':'rgba(168,85,247,0.12)','--scrollbar-thumb':'#4a2e70' },
        preview:['#1a0a2e','#16082b','#a855f7']
    },
    'ocean-depths': {
        name:'Ocean Depths',
        colors:{ '--bg-primary':'#0a1628','--bg-secondary':'#0d1b30','--bg-tertiary':'#152238','--bg-hover':'#1a2940','--bg-active':'#1f304a','--bg-floating':'#0e1e35','--accent':'#06b6d4','--accent-hover':'#22d3ee','--accent-dim':'rgba(6,182,212,0.15)','--text-primary':'#e0f0f8','--text-secondary':'#80a0b0','--text-muted':'#506070','--border':'#1e3448','--mention-bg':'rgba(6,182,212,0.12)','--scrollbar-thumb':'#2a4058' },
        preview:['#0a1628','#0d1b30','#06b6d4']
    },
    'emerald-night': {
        name:'Emerald Night',
        colors:{ '--bg-primary':'#0a1a0f','--bg-secondary':'#0d200f','--bg-tertiary':'#152815','--bg-hover':'#1a3018','--bg-active':'#1f381e','--bg-floating':'#0e2212','--accent':'#10b981','--accent-hover':'#34d399','--accent-dim':'rgba(16,185,129,0.15)','--text-primary':'#e0f0e8','--text-secondary':'#80b090','--text-muted':'#507060','--border':'#1e3e28','--mention-bg':'rgba(16,185,129,0.12)','--scrollbar-thumb':'#2a4e32' },
        preview:['#0a1a0f','#0d200f','#10b981']
    },
    'crimson-dark': {
        name:'Crimson Dark',
        colors:{ '--bg-primary':'#1a0a0a','--bg-secondary':'#200d0d','--bg-tertiary':'#2a1515','--bg-hover':'#301a1a','--bg-active':'#381e1e','--bg-floating':'#220e0e','--accent':'#ef4444','--accent-hover':'#f87171','--accent-dim':'rgba(239,68,68,0.15)','--text-primary':'#f0e0e0','--text-secondary':'#b08080','--text-muted':'#705050','--border':'#3e1e1e','--mention-bg':'rgba(239,68,68,0.12)','--scrollbar-thumb':'#4e2a2a' },
        preview:['#1a0a0a','#200d0d','#ef4444']
    },
    'arctic': {
        name:'Arctic Light',
        colors:{ '--bg-primary':'#ffffff','--bg-secondary':'#f2f3f5','--bg-tertiary':'#e3e5e8','--bg-hover':'#ebedef','--bg-active':'#d3d5d8','--bg-floating':'#f8f8f8','--accent':'#5865f2','--accent-hover':'#4752c4','--accent-dim':'rgba(88,101,242,0.1)','--text-primary':'#2e3338','--text-secondary':'#4f5660','--text-muted':'#96989d','--border':'#e3e5e8','--mention-bg':'rgba(88,101,242,0.08)','--scrollbar-thumb':'#c4c9ce' },
        preview:['#ffffff','#f2f3f5','#5865f2']
    }
};

let currentTheme = 'midnight-gold';

// ======================== SOCKET ========================
const socket = io({
    transports: ["websocket", "polling"],
    reconnection: true, reconnectionDelay: 1000, reconnectionAttempts: 10
});

// ======================== HELPERS ========================
function esc(text) {
    const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
}
function getTime() {
    const n = new Date();
    return `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
}
function getInitial(name) { return (name || '?')[0].toUpperCase(); }

// ======================== THEME ========================
function applyTheme(id) {
    const theme = THEMES[id];
    if (!theme) return;
    currentTheme = id;
    Object.entries(theme.colors).forEach(([k,v]) => document.documentElement.style.setProperty(k,v));
    document.querySelectorAll('.theme-card').forEach(c => {
        c.classList.toggle('active', c.dataset.theme === id);
    });
    localStorage.setItem('arabiac-theme', id);
}

function applyCustomTheme() {
    const accent = document.getElementById('customAccent').value;
    const bg = document.getElementById('customBg').value;
    const sidebar = document.getElementById('customSidebar').value;
    document.documentElement.style.setProperty('--accent', accent);
    document.documentElement.style.setProperty('--accent-hover', accent);
    document.documentElement.style.setProperty('--accent-dim', accent + '22');
    document.documentElement.style.setProperty('--mention-bg', accent + '1a');
    document.documentElement.style.setProperty('--bg-primary', bg);
    const h = (c,a) => {
        const n=parseInt(c.replace('#',''),16), R=Math.min(255,(n>>16)+a),
              G=Math.min(255,((n>>8)&0xFF)+a), B=Math.min(255,(n&0xFF)+a);
        return '#'+((1<<24)+(R<<16)+(G<<8)+B).toString(16).slice(1);
    };
    document.documentElement.style.setProperty('--bg-hover', h(bg,20));
    document.documentElement.style.setProperty('--bg-tertiary', h(bg,24));
    document.documentElement.style.setProperty('--bg-secondary', sidebar);
    document.documentElement.style.setProperty('--border', h(sidebar,20));
    document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
    showToast('Theme', 'Custom theme applied!');
}

function buildThemeGrid() {
    const grid = document.getElementById('themeGrid');
    grid.innerHTML = '';
    Object.entries(THEMES).forEach(([id, t]) => {
        const card = document.createElement('div');
        card.className = `theme-card ${id === currentTheme ? 'active' : ''}`;
        card.dataset.theme = id;
        card.onclick = () => applyTheme(id);
        card.innerHTML = `
            <div class="theme-preview">
                ${t.preview.map(c => `<div style="background:${c}"></div>`).join('')}
            </div>
            <div class="theme-card-name">${t.name}</div>
        `;
        grid.appendChild(card);
    });
}

// ======================== TOASTS ========================
function showToast(title, text, type = '') {
    if (!document.getElementById('setNotifs').checked && type !== 'achievement') return;
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type === 'achievement' ? 'toast-achievement' : ''}`;
    toast.innerHTML = `<div class="toast-title">${esc(title)}</div><div class="toast-text">${esc(text)}</div>`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 4000);
}

// ======================== LOGIN ========================
function doLogin(guest) {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const color = document.getElementById('loginColor').value;
    if (!guest && !username) { alert('Enter a username!'); return; }
    if (!guest && username.length < 2) { alert('Username must be 2+ characters!'); return; }
    socket.emit('user-login', { username, password, color, isGuest: guest });
}

// ======================== MESSAGES ========================
function addMessage(username, text, color, timestamp, status, isHistory) {
    const area = document.getElementById('messagesArea');
    const div = document.createElement('div');
    div.className = 'message message-new-group';

    let msgHtml = esc(text);
    if (currentUser && msgHtml.includes('@' + currentUser)) {
        msgHtml = msgHtml.replace(new RegExp('@' + esc(currentUser), 'g'),
            `<span class="mention">@${esc(currentUser)}</span>`);
    }

    div.innerHTML = `
        <div class="msg-avatar" style="background:${color};">${getInitial(username)}</div>
        <div class="msg-body">
            <div class="msg-header">
                <span class="msg-author" style="color:${color};" ondblclick="openPM('${esc(username)}')">${esc(username)}</span>
                <span class="msg-time">${timestamp}</span>
            </div>
            <div class="msg-text">${msgHtml}</div>
            <div class="msg-reactions">
                <span class="reaction-chip" onclick="react(this)">üëç 0</span>
            </div>
        </div>
    `;
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
    messageCount++;
    if (!isHistory && username !== currentUser) showToast(username, text.substring(0,60));
}

function addSystemMsg(text) {
    const area = document.getElementById('messagesArea');
    const div = document.createElement('div');
    div.className = 'msg-system';
    div.innerHTML = `<div class="msg-system-dot"></div><div class="msg-system-text">${esc(text)}</div>`;
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
}

function addErrorMsg(text) {
    const area = document.getElementById('messagesArea');
    const div = document.createElement('div');
    div.className = 'msg-error';
    div.innerHTML = `‚ö† ${esc(text)}`;
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
}

function addActionMsg(username, action, color, timestamp) {
    const area = document.getElementById('messagesArea');
    const div = document.createElement('div');
    div.className = 'msg-action';
    div.innerHTML = `<span class="msg-time">${timestamp}</span> <em style="color:${color};">‚òÖ ${esc(username)} ${esc(action)}</em>`;
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
}

function addImageMsg(username, src, color, timestamp) {
    const area = document.getElementById('messagesArea');
    const div = document.createElement('div');
    div.className = 'message message-new-group';
    div.innerHTML = `
        <div class="msg-avatar" style="background:${color};">${getInitial(username)}</div>
        <div class="msg-body">
            <div class="msg-header">
                <span class="msg-author" style="color:${color};">${esc(username)}</span>
                <span class="msg-time">${timestamp}</span>
            </div>
            <img src="${src}" class="msg-image" onclick="window.open(this.src)" title="Click to view full size">
        </div>
    `;
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
}

function react(el) {
    const m = el.textContent.match(/\d+/);
    const c = m ? parseInt(m[0]) + 1 : 1;
    el.textContent = `üëç ${c}`;
    socket.emit('add-reaction', { messageId: Date.now(), reaction: 'thumbsup' });
}

// ======================== SEND ========================
function sendMessage() {
    const input = document.getElementById('msgInput');
    const msg = input.value.trim();
    if (!msg) return;
    socket.emit('chat-message', { message: msg, timestamp: getTime() });
    input.value = '';
    socket.emit('stop-typing');
}

// ======================== ROOMS ========================
function switchRoom(room) {
    if (room === currentRoom) return;
    const area = document.getElementById('messagesArea');
    roomMessages[currentRoom] = area.innerHTML;
    area.innerHTML = '';
    document.querySelectorAll('.channel').forEach(c => {
        c.classList.toggle('active', c.dataset.room === room);
    });
    socket.emit('chat-message', { message: `/join ${room}`, timestamp: getTime() });
}

// ======================== MEMBERS ========================
function updateMembers() {
    const list = document.getElementById('membersList');
    const online = users.filter(u => (u.status||'Online') === 'Online');
    const away = users.filter(u => (u.status||'Online') === 'Away');
    const busy = users.filter(u => (u.status||'Online') === 'Busy');

    let html = '';
    if (online.length) {
        html += `<div class="members-category">Online ‚Äî ${online.length}</div>`;
        online.forEach(u => html += memberHtml(u, 'var(--online)'));
    }
    if (away.length) {
        html += `<div class="members-category">Away ‚Äî ${away.length}</div>`;
        away.forEach(u => html += memberHtml(u, 'var(--idle)'));
    }
    if (busy.length) {
        html += `<div class="members-category">Busy ‚Äî ${busy.length}</div>`;
        busy.forEach(u => html += memberHtml(u, 'var(--dnd)'));
    }
    list.innerHTML = html;
}

function memberHtml(u, dotColor) {
    const name = u.username || u;
    const color = u.color || 'var(--accent)';
    return `<div class="member-item" ondblclick="openPM('${esc(name)}')">
        <div class="member-avatar" style="background:${color};">
            ${getInitial(name)}
            <div class="member-status-dot" style="background:${dotColor};"></div>
        </div>
        <div class="member-name">${esc(name)}</div>
    </div>`;
}

function toggleMembers() {
    const s = document.getElementById('membersSidebar');
    s.classList.toggle('hidden');
    membersVisible = !membersVisible;
}

// ======================== PM ========================
function openPM(username) {
    if (username === currentUser) return;
    pmTarget = username;
    document.getElementById('pmTargetName').textContent = username;
    document.getElementById('pmMessages').innerHTML = '';
    document.getElementById('pmOverlay').classList.add('active');
    document.getElementById('pmInput').focus();
}
function closePM() { document.getElementById('pmOverlay').classList.remove('active'); }
function sendPM() {
    const input = document.getElementById('pmInput');
    const msg = input.value.trim();
    if (!msg || !pmTarget) return;
    socket.emit('chat-message', { message: `/msg ${pmTarget} ${msg}`, timestamp: getTime() });
    const box = document.getElementById('pmMessages');
    box.innerHTML += `<div class="pm-msg"><strong style="color:${userColor};">You:</strong> ${esc(msg)}</div>`;
    box.scrollTop = box.scrollHeight;
    input.value = '';
}

// ======================== SETTINGS ========================
function openSettings() {
    document.getElementById('setUsername').value = currentUser;
    document.getElementById('setColor').value = userColor;
    buildThemeGrid();
    renderAchievements();
    document.getElementById('settingsOverlay').classList.add('active');
}
function closeSettings() { document.getElementById('settingsOverlay').classList.remove('active'); }

function switchTab(id) {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector(`.modal-tab[onclick="switchTab('${id}')"]`).classList.add('active');
    document.getElementById('tab-' + id).classList.add('active');
}

function saveProfile() {
    const newColor = document.getElementById('setColor').value;
    if (newColor !== userColor) {
        socket.emit('chat-message', { message: `/color ${newColor}`, timestamp: getTime() });
    }
    const newStatus = document.getElementById('setStatus').value;
    if (newStatus !== userStatus) {
        userStatus = newStatus;
        socket.emit('chat-message', { message: `/status ${newStatus}`, timestamp: getTime() });
        document.getElementById('myStatus').textContent = newStatus;
    }
    showToast('Settings', 'Profile saved!');
    closeSettings();
}

function renderAchievements() {
    const list = document.getElementById('achList');
    list.innerHTML = ALL_ACHIEVEMENTS.map(a => {
        const unlocked = achievements.includes(a.id);
        return `<div class="ach-item ${unlocked ? '' : 'locked'}">
            <div class="ach-icon">${a.icon}</div>
            <div class="ach-info">
                <div class="ach-title">${unlocked ? '‚úì' : '?'} ${a.title}</div>
                <div class="ach-desc">${a.desc}</div>
            </div>
        </div>`;
    }).join('');
}

// ======================== MISC ========================
function downloadLog() {
    const text = document.getElementById('messagesArea').innerText;
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `arabiac-${currentRoom}-${Date.now()}.txt`;
    a.click();
    showToast('Download', 'Chat log saved!');
}

function updateUI() {
    document.getElementById('myName').textContent = currentUser;
    document.getElementById('myAvatar').textContent = getInitial(currentUser);
    document.getElementById('myAvatar').style.background = userColor;
}

// ======================== IMAGE UPLOAD ========================
document.addEventListener('DOMContentLoaded', () => {
    // Load saved theme
    const saved = localStorage.getItem('arabiac-theme');
    if (saved && THEMES[saved]) applyTheme(saved);

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) { alert('Max 5MB!'); return; }
        const reader = new FileReader();
        reader.onload = (ev) => {
            socket.emit('image-upload', { imageData: ev.target.result, timestamp: getTime() });
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    });

    // Enter to send
    document.getElementById('msgInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
    });
    document.getElementById('pmInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); sendPM(); }
    });

    // Typing indicator
    document.getElementById('msgInput').addEventListener('input', () => {
        socket.emit('typing');
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => socket.emit('stop-typing'), 1000);
    });

    // Close modals on overlay click
    document.getElementById('settingsOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeSettings();
    });
    document.getElementById('pmOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closePM();
    });

    // ======================== SOCKET EVENTS ========================
    socket.on('connect', () => {
        document.getElementById('connDot').style.background = 'var(--online)';
    });
    socket.on('disconnect', () => {
        document.getElementById('connDot').style.background = 'var(--dnd)';
    });

    socket.on('login-success', (data) => {
        currentUser = data.username;
        userColor = data.color;
        isGuest = data.isGuest;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('app').classList.add('active');
        updateUI();
    });

    socket.on('login-error', (msg) => {
        alert('Login Error: ' + msg);
    });

    socket.on('chat-message', (data) => {
        addMessage(data.username, data.message, data.color, data.timestamp, data.status, false);
    });

    socket.on('image-message', (data) => {
        addImageMsg(data.username, data.imageData, data.color, data.timestamp);
    });

    socket.on('image-keyword', (data) => {
        addImageMsg(data.username, data.imageUrl, data.color, data.timestamp);
    });

    socket.on('action-message', (data) => {
        addActionMsg(data.username, data.action, data.color, data.timestamp);
    });

    socket.on('system-message', (data) => {
        addSystemMsg(data.text);
    });

    socket.on('user-joined', (data) => {
        addSystemMsg(`${data.username} joined the channel`);
    });

    socket.on('user-left', (data) => {
        addSystemMsg(`${data.username} left the channel`);
    });

    socket.on('users-update', (list) => {
        users = list;
        updateMembers();
    });

    socket.on('user-typing', (data) => {
        document.getElementById('typingIndicator').textContent = `${data.username} is typing...`;
    });

    socket.on('user-stop-typing', () => {
        document.getElementById('typingIndicator').textContent = '';
    });

    socket.on('room-changed', (room) => {
        currentRoom = room;
        document.getElementById('headerChannel').textContent = room;
        document.getElementById('headerTopic').textContent = ROOM_TOPICS[room] || '';
        document.getElementById('msgInput').placeholder = `Message #${room}`;
        document.querySelectorAll('.channel').forEach(c => {
            c.classList.toggle('active', c.dataset.room === room);
        });
        messageCount = 0;
    });

    socket.on('message-history', (messages) => {
        const area = document.getElementById('messagesArea');
        area.innerHTML = '';
        if (!messages || !messages.length) {
            addSystemMsg(`Welcome to #${currentRoom}!`);
            return;
        }
        messages.forEach(m => {
            if (m.message_type === 'normal') addMessage(m.username, m.message, m.color, m.timestamp, 'Online', true);
            else if (m.message_type === 'action') addActionMsg(m.username, m.message, m.color, m.timestamp);
            else if (m.message_type === 'image') addSystemMsg(`${m.username} shared an image`);
        });
        roomMessages[currentRoom] = area.innerHTML;
    });

    socket.on('color-changed', (color) => {
        userColor = color;
        updateUI();
    });

    socket.on('clear-chat', () => {
        document.getElementById('messagesArea').innerHTML = '';
        addSystemMsg('Chat cleared.');
        messageCount = 0;
    });

    socket.on('private-message', (data) => {
        openPM(data.from);
        const box = document.getElementById('pmMessages');
        box.innerHTML += `<div class="pm-msg"><strong style="color:${data.color};">${esc(data.from)}:</strong> ${esc(data.message)}</div>`;
        box.scrollTop = box.scrollHeight;
        if (document.getElementById('setPmNotifs').checked) {
            showToast(`PM from ${data.from}`, data.message);
        }
    });

    socket.on('private-message-sent', (data) => {
        showToast('PM Sent', `Message sent to ${data.to}`);
    });

    socket.on('message-blocked', (msg) => addErrorMsg(msg));
    socket.on('command-error', (msg) => addErrorMsg(msg));

    socket.on('achievement-unlocked', (data) => {
        const id = data.title.toLowerCase().replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-');
        if (!achievements.includes(id)) achievements.push(id);
        showToast('üèÜ Achievement Unlocked!', `${data.title} ‚Äî ${data.description}`, 'achievement');
        renderAchievements();
    });

    socket.on('achievements-update', (data) => {
        achievements = data || [];
        renderAchievements();
    });

    socket.on('reaction-added', () => {});
});
</script>
</body>
</html>
