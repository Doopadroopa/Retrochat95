<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroChat95 v1.0 - ULTIMATE EDITION</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Comic Sans', cursive;
            background: #008080;
            overflow: hidden;
            height: 100vh;
        }

        body.crt-mode::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 99999;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 0.97; }
            50% { opacity: 1; }
        }

        body.crt-mode {
            filter: blur(0.3px);
        }

        .desktop {
            height: 100vh;
            position: relative;
            padding: 10px;
        }

        .desktop-icon {
            width: 80px;
            text-align: center;
            cursor: pointer;
            position: absolute;
            user-select: none;
        }

        .desktop-icon-image {
            width: 50px;
            height: 50px;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            margin: 0 auto 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .desktop-icon-label {
            color: white;
            font-size: 11px;
            text-shadow: 1px 1px 2px black;
            word-wrap: break-word;
        }

        .desktop-icon:active .desktop-icon-image {
            border-color: #000000 #ffffff #ffffff #000000;
        }

        .window {
            position: absolute;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            display: none;
        }

        .window.active {
            display: block;
            z-index: 100;
        }

        .title-bar {
            background: linear-gradient(to right, #000080, #1084d0);
            color: white;
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            cursor: move;
            user-select: none;
        }

        .title-bar-controls button {
            width: 18px;
            height: 18px;
            font-size: 10px;
            padding: 0;
            cursor: pointer;
        }

        .window-body {
            padding: 10px;
        }

        button {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            padding: 5px 15px;
            font-family: 'Comic Sans MS', cursive;
            cursor: pointer;
            font-size: 14px;
        }

        button:active {
            border-color: #000000 #ffffff #ffffff #000000;
        }

        input[type="text"], input[type="password"], textarea {
            padding: 5px;
            border: 2px inset #808080;
            font-family: 'Comic Sans MS', cursive;
            font-size: 14px;
        }

        input[type="color"] {
            width: 50px;
            height: 30px;
            border: 2px inset #808080;
            cursor: pointer;
        }

        .chat-window {
            width: 780px;
            height: 600px;
            top: 50px;
            left: 50px;
        }

        .menu-bar {
            background: #c0c0c0;
            border-bottom: 2px solid #808080;
            display: flex;
            gap: 5px;
            padding: 2px;
        }

        .menu-item {
            padding: 4px 10px;
            cursor: pointer;
            position: relative;
        }

        .menu-item:hover {
            background: #000080;
            color: white;
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            min-width: 180px;
            z-index: 1000;
        }

        .dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 5px 20px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #000080;
            color: white;
        }

        .rooms-selector {
            display: flex;
            gap: 5px;
            padding: 5px;
            background: #c0c0c0;
            border-bottom: 2px solid #808080;
        }

        .room-tab {
            padding: 5px 15px;
            background: #808080;
            border: 2px solid;
            border-color: #000000 #ffffff #ffffff #000000;
            cursor: pointer;
            font-size: 12px;
        }

        .room-tab.active {
            background: #c0c0c0;
            border-color: #ffffff #000000 #000000 #ffffff;
        }

        .chat-container {
            display: flex;
            height: 440px;
            gap: 10px;
        }

        .users-panel {
            width: 180px;
            border: 2px inset #808080;
            background: white;
            padding: 5px;
            overflow-y: auto;
        }

        .user-item {
            padding: 3px;
            margin: 2px 0;
            background: #c0c0c0;
            border: 1px solid #808080;
            font-size: 12px;
        }

        .messages-area {
            flex: 1;
            border: 2px inset #808080;
            background: white;
            padding: 10px;
            overflow-y: auto;
            font-size: 14px;
        }

        .message {
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .message-header {
            font-weight: bold;
            color: #000080;
            margin-bottom: 2px;
        }

        .message-system {
            font-style: italic;
            color: #808080;
            font-size: 12px;
        }

        .message-error {
            color: #ff0000;
            font-weight: bold;
        }

        .timestamp {
            color: #808080;
            font-size: 11px;
        }

        .message-content {
            margin-left: 10px;
        }

        .message-highlight {
            background: #ffff00;
            padding: 2px;
        }

        .message-image {
            max-width: 500px;
            max-height: 500px;
            margin: 5px 0;
            border: 2px solid #808080;
            image-rendering: pixelated;
            cursor: pointer;
        }

        .typing-indicator {
            font-style: italic;
            color: #808080;
            font-size: 12px;
            min-height: 18px;
        }

        .input-area {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .status-bar {
            background: #c0c0c0;
            border-top: 2px solid #ffffff;
            padding: 2px 5px;
            font-size: 11px;
            display: flex;
            gap: 20px;
        }

        .login-window {
            width: 480px;
            height: 420px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: bold;
        }

        .game-window {
            width: 500px;
            height: 580px;
            top: 80px;
            left: 200px;
        }

        .game-board {
            display: grid;
            gap: 2px;
            margin: 20px auto;
            background: #808080;
            padding: 5px;
            border: 2px inset #808080;
        }

        .game-cell {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-cell:active {
            border-color: #000000 #ffffff #ffffff #000000;
        }

        .game-info {
            text-align: center;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
        }

        .notepad-window {
            width: 600px;
            height: 500px;
            top: 100px;
            left: 180px;
        }

        .notepad-textarea {
            width: 100%;
            height: 380px;
            border: 2px inset #808080;
            padding: 10px;
            font-family: 'Courier New', monospace;
            resize: none;
        }

        .paint-window {
            width: 700px;
            height: 600px;
            top: 60px;
            left: 120px;
        }

        .paint-canvas {
            border: 2px inset #808080;
            background: white;
            cursor: crosshair;
        }

        .paint-tools {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .calculator-window {
            width: 320px;
            height: 480px;
            top: 150px;
            left: 250px;
        }

        .calc-display {
            width: 100%;
            height: 60px;
            border: 2px inset #808080;
            padding: 10px;
            font-size: 24px;
            text-align: right;
            margin-bottom: 10px;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .calc-button {
            height: 50px;
            font-size: 18px;
        }

        .screensaver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            z-index: 100000;
        }

        .screensaver.active {
            display: block;
        }

        .screensaver-text {
            position: absolute;
            color: #00ff00;
            font-size: 24px;
            font-weight: bold;
        }

        .notification {
            position: fixed;
            top: 50px;
            right: 50px;
            background: #ffffcc;
            border: 2px solid #000;
            padding: 15px;
            max-width: 300px;
            display: none;
            z-index: 10000;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .achievement-popup {
            position: fixed;
            top: 100px;
            right: 50px;
            background: #000080;
            color: white;
            border: 2px solid #fff;
            padding: 15px;
            width: 320px;
            display: none;
            z-index: 10001;
        }

        .achievement-popup.show {
            display: block;
            animation: slideIn 0.5s;
        }

        .win95-error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            width: 420px;
            display: none;
            z-index: 10002;
        }

        .win95-error.show {
            display: block;
        }

        .error-body {
            padding: 20px;
            display: flex;
            gap: 15px;
        }

        .error-icon {
            font-size: 32px;
        }

        .error-buttons {
            padding: 10px;
            text-align: center;
        }

        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: #c0c0c0;
            border-top: 2px solid #ffffff;
            display: flex;
            align-items: center;
            padding: 2px;
            gap: 5px;
            z-index: 200;
        }

        .start-button {
            height: 32px;
            padding: 0 20px;
            font-weight: bold;
            font-size: 16px;
        }

        .start-menu {
            display: none;
            position: absolute;
            bottom: 42px;
            left: 2px;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            min-width: 220px;
            z-index: 1000;
        }

        .start-menu.show {
            display: block;
        }

        .start-menu-item {
            padding: 8px 20px;
            cursor: pointer;
        }

        .start-menu-item:hover {
            background: #000080;
            color: white;
        }

        .clock {
            margin-left: auto;
            padding: 0 10px;
            border: 2px inset #808080;
            height: 32px;
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .pixel-canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="desktop">
        <!-- Desktop Icons -->
        <div class="desktop-icon" ondblclick="openWindow('chatWindow')" style="top:20px;left:20px;">
            <div class="desktop-icon-image">&#128172;</div>
            <div class="desktop-icon-label">RetroChat95</div>
        </div>

        <div class="desktop-icon" ondblclick="openGame('tictactoe')" style="top:120px;left:20px;">
            <div class="desktop-icon-image">X</div>
            <div class="desktop-icon-label">Tic-Tac-Toe</div>
        </div>

        <div class="desktop-icon" ondblclick="openGame('minesweeper')" style="top:220px;left:20px;">
            <div class="desktop-icon-image">*</div>
            <div class="desktop-icon-label">Minesweeper</div>
        </div>

        <div class="desktop-icon" ondblclick="openGame('snake')" style="top:320px;left:20px;">
            <div class="desktop-icon-image">~</div>
            <div class="desktop-icon-label">Snake</div>
        </div>

        <div class="desktop-icon" ondblclick="openWindow('notepadWindow')" style="top:20px;right:20px;">
            <div class="desktop-icon-image">&#128221;</div>
            <div class="desktop-icon-label">Notepad</div>
        </div>

        <div class="desktop-icon" ondblclick="openWindow('paintWindow')" style="top:120px;right:20px;">
            <div class="desktop-icon-image">&#127912;</div>
            <div class="desktop-icon-label">Paint</div>
        </div>

        <div class="desktop-icon" ondblclick="openWindow('calculatorWindow')" style="top:220px;right:20px;">
            <div class="desktop-icon-image">+</div>
            <div class="desktop-icon-label">Calculator</div>
        </div>

        <div class="desktop-icon" ondblclick="startScreenSaver()" style="top:320px;right:20px;">
            <div class="desktop-icon-image">&#127763;</div>
            <div class="desktop-icon-label">Screensaver</div>
        </div>

        <!-- Login Window -->
        <div class="window login-window active" id="loginWindow">
            <div class="title-bar" onmousedown="startDrag(event, this.parentElement)">
                <span>RetroChat95 v1.0 - Login</span>
            </div>
            <div class="window-body">
                <div class="login-form">
                    <h2 style="text-align:center;color:#000080;">Welcome!</h2>
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="usernameInput" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>Password (optional):</label>
                        <input type="password" id="passwordInput">
                    </div>
                    <div class="form-group">
                        <label>Color:</label>
                        <input type="color" id="userColor" value="#ff00ff">
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button onclick="login(false)" style="flex:1;">Login</button>
                        <button onclick="login(true)" style="flex:1;">Guest</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Window -->
        <div class="window chat-window" id="chatWindow">
            <div class="title-bar" onmousedown="startDrag(event, this.parentElement)">
                <span>RetroChat95 v1.0 - #<span id="currentRoom">general</span></span>
                <div class="title-bar-controls">
                    <button onclick="minimizeWindow('chatWindow')">_</button>
                    <button onclick="closeWindow('chatWindow')">X</button>
                </div>
            </div>
            <div class="window-body">
                <div class="menu-bar">
                    <div class="menu-item" onclick="toggleDropdown('fileMenu')">
                        File
                        <div class="dropdown" id="fileMenu">
                            <div class="dropdown-item" onclick="downloadChat();closeAllDropdowns();">Download Log</div>
                            <div class="dropdown-item" onclick="clearChat();closeAllDropdowns();">Clear Chat</div>
                        </div>
                    </div>
                    <div class="menu-item" onclick="toggleDropdown('viewMenu')">
                        View
                        <div class="dropdown" id="viewMenu">
                            <div class="dropdown-item" onclick="toggleCRT();closeAllDropdowns();">Toggle CRT</div>
                        </div>
                    </div>
                </div>

                <div class="rooms-selector">
                    <div class="room-tab active" onclick="switchRoom('general')">#general</div>
                    <div class="room-tab" onclick="switchRoom('random')">#random</div>
                    <div class="room-tab" onclick="switchRoom('images')">#images</div>
                    <div class="room-tab" onclick="switchRoom('windows')">#windows</div>
                </div>

                <div class="chat-container">
                    <div class="users-panel">
                        <strong>ONLINE</strong>
                        <div id="usersList"></div>
                    </div>
                    <div class="messages-area" id="messagesArea">
                        <div class="message message-system">
                            Welcome to RetroChat95! Type /help for commands.
                        </div>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator"></div>
                
                <div class="input-area">
                    <button onclick="triggerImageUpload()">IMG</button>
                    <input type="file" id="imageInput" accept="image/*" style="display:none;">
                    <input type="text" id="messageInput" placeholder="Type message..." maxlength="500" style="flex:1;">
                    <button onclick="sendMessage()">SEND</button>
                </div>

                <div class="status-bar">
                    <span id="statusText">Connected</span>
                    <span id="userCount">Users: 0</span>
                    <span id="roomInfo">Room: #general</span>
                </div>
            </div>
        </div>

        <!-- Game Window -->
        <div class="window game-window" id="gameWindow">
            <div class="title-bar" onmousedown="startDrag(event, this.parentElement)">
                <span id="gameTitle">Game</span>
                <div class="title-bar-controls">
                    <button onclick="closeWindow('gameWindow')">X</button>
                </div>
            </div>
            <div class="window-body">
                <div id="gameContent"></div>
            </div>
        </div>

        <!-- Notepad Window -->
        <div class="window notepad-window" id="notepadWindow">
            <div class="title-bar" onmousedown="startDrag(event, this.parentElement)">
                <span>Notepad</span>
                <div class="title-bar-controls">
                    <button onclick="closeWindow('notepadWindow')">X</button>
                </div>
            </div>
            <div class="window-body">
                <textarea class="notepad-textarea" id="notepadText" placeholder="Type your notes here..."></textarea>
                <button onclick="downloadNotepad()">Save</button>
                <button onclick="clearNotepad()">Clear</button>
            </div>
        </div>

        <!-- Paint Window -->
        <div class="window paint-window" id="paintWindow">
            <div class="title-bar" onmousedown="startDrag(event, this.parentElement)">
                <span>Paint</span>
                <div class="title-bar-controls">
                    <button onclick="closeWindow('paintWindow')">X</button>
                </div>
            </div>
            <div class="window-body">
                <div class="paint-tools">
                    <button onclick="setPaintColor('#000000')">Black</button>
                    <button onclick="setPaintColor('#ff0000')">Red</button>
                    <button onclick="setPaintColor('#00ff00')">Green</button>
                    <button onclick="setPaintColor('#0000ff')">Blue</button>
                    <button onclick="clearPaint()">Clear</button>
                </div>
                <canvas id="paintCanvas" class="paint-canvas" width="660" height="480"></canvas>
            </div>
        </div>

        <!-- Calculator Window -->
        <div class="window calculator-window" id="calculatorWindow">
            <div class="title-bar" onmousedown="startDrag(event, this.parentElement)">
                <span>Calculator</span>
                <div class="title-bar-controls">
                    <button onclick="closeWindow('calculatorWindow')">X</button>
                </div>
            </div>
            <div class="window-body">
                <input type="text" class="calc-display" id="calcDisplay" readonly value="0">
                <div class="calc-buttons">
                    <button class="calc-button" onclick="calcInput('7')">7</button>
                    <button class="calc-button" onclick="calcInput('8')">8</button>
                    <button class="calc-button" onclick="calcInput('9')">9</button>
                    <button class="calc-button" onclick="calcInput('/')">/</button>
                    <button class="calc-button" onclick="calcInput('4')">4</button>
                    <button class="calc-button" onclick="calcInput('5')">5</button>
                    <button class="calc-button" onclick="calcInput('6')">6</button>
                    <button class="calc-button" onclick="calcInput('*')">*</button>
                    <button class="calc-button" onclick="calcInput('1')">1</button>
                    <button class="calc-button" onclick="calcInput('2')">2</button>
                    <button class="calc-button" onclick="calcInput('3')">3</button>
                    <button class="calc-button" onclick="calcInput('-')">-</button>
                    <button class="calc-button" onclick="calcInput('0')">0</button>
                    <button class="calc-button" onclick="calcInput('.')">.</button>
                    <button class="calc-button" onclick="calcEquals()">=</button>
                    <button class="calc-button" onclick="calcInput('+')">+</button>
                    <button class="calc-button" onclick="calcClear()" style="grid-column: span 4;">Clear</button>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div class="notification" id="notification">
            <div id="notificationText"></div>
        </div>

        <div class="achievement-popup" id="achievementPopup">
            <div style="font-weight:bold;margin-bottom:5px;">[!] Achievement Unlocked!</div>
            <div id="achievementDesc"></div>
        </div>

        <div class="win95-error" id="win95Error">
            <div class="title-bar">
                <span>Error</span>
                <div class="title-bar-controls">
                    <button onclick="closeWin95Error()">X</button>
                </div>
            </div>
            <div class="error-body">
                <div class="error-icon">&#9888;</div>
                <div id="errorMessage"></div>
            </div>
            <div class="error-buttons">
                <button onclick="closeWin95Error()">OK</button>
            </div>
        </div>

        <!-- Screensaver -->
        <div class="screensaver" id="screensaver" onclick="stopScreenSaver()">
            <div class="screensaver-text" id="screensaverText">RetroChat95</div>
        </div>

        <!-- Taskbar -->
        <div class="taskbar">
            <button class="start-button" onclick="toggleStartMenu()">Start</button>
            <div class="start-menu" id="startMenu">
                <div class="start-menu-item" onclick="openWindow('chatWindow');toggleStartMenu();">Chat</div>
                <div class="start-menu-item" onclick="toggleCRT();toggleStartMenu();">CRT Mode</div>
            </div>
            <div class="clock" id="clock">12:00 PM</div>
        </div>
    </div>

    <canvas id="pixelCanvas" class="pixel-canvas"></canvas>

<script>
// ============================================================================
// RETROCHAT95 v1.0 - ULTIMATE EDITION
// Complete Client with All Features and Games
// ============================================================================

// GLOBAL STATE
let currentUser = '';
let userColor = '#ff00ff';
let currentRoom = 'general';
let users = [];
let isGuest = false;
let pixelationLevel = 3;
let typingTimeout;

// ROOM MESSAGE STORAGE (FIX FOR BUG #2 and #3)
let roomMessages = {
    'general': '',
    'random': '',
    'images': '',
    'windows': ''
};

// SOCKET CONNECTION
// UPDATE THIS WITH YOUR RAILWAY URL!
const socket = io("retrochat95-production.up.railway.app", {
    transports: ["websocket", "polling"],
    reconnection: true
});

// ============================================================================
// WINDOW DRAGGING
// ============================================================================

let isDragging = false;
let currentWindow = null;
let offsetX = 0;
let offsetY = 0;
let highestZIndex = 100;

function startDrag(e, windowElement) {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
    
    isDragging = true;
    currentWindow = windowElement;
    
    highestZIndex++;
    currentWindow.style.zIndex = highestZIndex;
    
    const rect = currentWindow.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    
    e.preventDefault();
}

document.addEventListener('mousemove', (e) => {
    if (isDragging && currentWindow) {
        let newX = e.clientX - offsetX;
        let newY = e.clientY - offsetY;
        
        const maxX = window.innerWidth - currentWindow.offsetWidth;
        const maxY = window.innerHeight - currentWindow.offsetHeight - 40;
        
        newX = Math.max(0, Math.min(newX, maxX));
        newY = Math.max(0, Math.min(newY, maxY));
        
        currentWindow.style.left = newX + 'px';
        currentWindow.style.top = newY + 'px';
    }
});

document.addEventListener('mouseup', () => {
    isDragging = false;
    currentWindow = null;
});

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function getCurrentTime() {
    const now = new Date();
    return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openWindow(id) {
    document.getElementById(id).classList.add('active');
}

function closeWindow(id) {
    document.getElementById(id).classList.remove('active');
}

function minimizeWindow(id) {
    closeWindow(id);
}

function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    document.querySelectorAll('.dropdown').forEach(d => {
        if (d.id !== id) d.classList.remove('show');
    });
    dropdown.classList.toggle('show');
}

function closeAllDropdowns() {
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
}

function toggleStartMenu() {
    document.getElementById('startMenu').classList.toggle('show');
}

function toggleCRT() {
    document.body.classList.toggle('crt-mode');
}

// ============================================================================
// LOGIN
// ============================================================================

function login(guestMode) {
    const username = document.getElementById('usernameInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const color = document.getElementById('userColor').value;

    if (!guestMode && !username) {
        alert('Enter a username!');
        return;
    }

    isGuest = guestMode;
    currentUser = username;
    userColor = color;

    socket.emit('user-login', {
        username: username,
        color: color,
        password: password,
        isGuest: guestMode
    });

    closeWindow('loginWindow');
    openWindow('chatWindow');
}

// ============================================================================
// CHAT FUNCTIONS
// ============================================================================

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message) return;

    socket.emit('chat-message', {
        message: message,
        timestamp: getCurrentTime()
    });

    input.value = '';
    socket.emit('stop-typing');
}

function switchRoom(room) {
    if (room === currentRoom) return;
    
    // SAVE current room messages BEFORE switching (FIX FOR BUG #2)
    const messagesArea = document.getElementById('messagesArea');
    roomMessages[currentRoom] = messagesArea.innerHTML;
    
    socket.emit('chat-message', {
        message: `/join ${room}`,
        timestamp: getCurrentTime()
    });
    
    document.querySelectorAll('.room-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent === '#' + room) tab.classList.add('active');
    });
    
    currentRoom = room;
    document.getElementById('currentRoom').textContent = room;
    document.getElementById('roomInfo').textContent = `Room: #${room}`;
}

// ADD MESSAGE (WITH isHistory parameter to FIX BUG #1)
function addMessage(username, text, color, timestamp, isHistory = false) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';

    let messageText = escapeHtml(text);
    if (messageText.includes('@' + currentUser)) {
        messageText = messageText.replace(
            new RegExp('@' + escapeHtml(currentUser), 'g'), 
            `<span class="message-highlight">@${escapeHtml(currentUser)}</span>`
        );
    }

    messageDiv.innerHTML = `
        <div class="message-header">
            <span style="color: ${color};">${escapeHtml(username)}</span>
            <span class="timestamp">[${timestamp}]</span>
        </div>
        <div class="message-content">${messageText}</div>
    `;

    messagesArea.appendChild(messageDiv);
    messagesArea.scrollTop = messagesArea.scrollHeight;

    // FIX FOR BUG #1: Only notify if NOT history
    if (!isHistory && username !== currentUser) {
        showNotification(`${username}: ${text.substring(0, 40)}...`);
    }
}

function addSystemMessage(text) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message message-system';
    messageDiv.textContent = text;
    messagesArea.appendChild(messageDiv);
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

function addErrorMessage(text) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message message-error';
    messageDiv.textContent = '[ERROR] ' + text;
    messagesArea.appendChild(messageDiv);
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

function addImageMessage(username, imageData, color, timestamp) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    messageDiv.innerHTML = `
        <div class="message-header">
            <span style="color: ${color};">${escapeHtml(username)}</span>
            <span class="timestamp">[${timestamp}]</span>
        </div>
        <div class="message-content">
            <img src="${imageData}" class="message-image" onclick="window.open(this.src)">
        </div>
    `;
    messagesArea.appendChild(messageDiv);
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

function updateUsersList() {
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = users.map(u => `
        <div class="user-item">${escapeHtml(u)}</div>
    `).join('');
    document.getElementById('userCount').textContent = `Users: ${users.length}`;
}

function showNotification(text) {
    const notif = document.getElementById('notification');
    document.getElementById('notificationText').textContent = text;
    notif.classList.add('show');
    setTimeout(() => notif.classList.remove('show'), 3000);
}

function showAchievement(title, desc) {
    const popup = document.getElementById('achievementPopup');
    document.getElementById('achievementDesc').textContent = `${title} - ${desc}`;
    popup.classList.add('show');
    setTimeout(() => popup.classList.remove('show'), 5000);
}

function closeWin95Error() {
    document.getElementById('win95Error').classList.remove('show');
}

function clearChat() {
    if (confirm('Clear your chat?')) {
        socket.emit('chat-message', {
            message: '/clear',
            timestamp: getCurrentTime()
        });
    }
}

function downloadChat() {
    const text = document.getElementById('messagesArea').innerText;
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `retrochat95-log-${Date.now()}.txt`;
    a.click();
}

function triggerImageUpload() {
    document.getElementById('imageInput').click();
}

// ============================================================================
// IMAGE HANDLING
// ============================================================================

document.getElementById('imageInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
        alert('Image too large! Max 5MB');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        pixelateImage(event.target.result);
    };
    reader.readAsDataURL(file);
});

function pixelateImage(imageData) {
    const canvas = document.getElementById('pixelCanvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = function() {
        const maxWidth = 500;
        const maxHeight = 500;
        let width = img.width;
        let height = img.height;

        if (width > maxWidth) {
            height = (maxWidth / width) * height;
            width = maxWidth;
        }
        if (height > maxHeight) {
            width = (maxHeight / height) * width;
            height = maxHeight;
        }

        const pixelSize = pixelationLevel * 2;
        const smallWidth = Math.ceil(width / pixelSize);
        const smallHeight = Math.ceil(height / pixelSize);

        canvas.width = smallWidth;
        canvas.height = smallHeight;
        ctx.drawImage(img, 0, 0, smallWidth, smallHeight);

        const pixelatedData = canvas.toDataURL('image/png');

        socket.emit('image-upload', {
            imageData: pixelatedData,
            timestamp: getCurrentTime()
        });
    };

    img.src = imageData;
}

// ============================================================================
// GAMES
// ============================================================================

function openGame(game) {
    openWindow('gameWindow');
    const gameContent = document.getElementById('gameContent');
    
    switch(game) {
        case 'tictactoe':
            document.getElementById('gameTitle').textContent = 'Tic-Tac-Toe';
            gameContent.innerHTML = `
                <div class="game-info" id="tttInfo">Your turn (X)</div>
                <div class="game-board" id="tttBoard" style="grid-template-columns: repeat(3, 80px); width: 250px;"></div>
                <button onclick="resetTTT()" style="margin: 10px auto; display: block;">New Game</button>
            `;
            initTicTacToe();
            break;
            
        case 'minesweeper':
            document.getElementById('gameTitle').textContent = 'Minesweeper';
            gameContent.innerHTML = `
                <div class="game-info">Click to reveal cells. Right-click to flag.</div>
                <div class="game-info" id="mineInfo">Mines: 10</div>
                <div class="game-board" id="mineBoard" style="grid-template-columns: repeat(8, 40px); width: 340px;"></div>
                <button onclick="resetMinesweeper()" style="margin: 10px auto; display: block;">New Game</button>
            `;
            initMinesweeper();
            break;
            
        case 'snake':
            document.getElementById('gameTitle').textContent = 'Snake';
            gameContent.innerHTML = `
                <div class="game-info" id="snakeInfo">Score: 0</div>
                <canvas id="snakeCanvas" width="400" height="400" style="border: 2px solid #000; display: block; margin: 10px auto;"></canvas>
                <div style="text-align: center;">Use Arrow Keys</div>
                <button onclick="resetSnake()" style="margin: 10px auto; display: block;">New Game</button>
            `;
            initSnake();
            break;
    }
}

// TIC-TAC-TOE
let tttBoard = ['', '', '', '', '', '', '', '', ''];
let tttPlayer = 'X';
let tttGameOver = false;

function initTicTacToe() {
    tttBoard = ['', '', '', '', '', '', '', '', ''];
    tttPlayer = 'X';
    tttGameOver = false;
    const board = document.getElementById('tttBoard');
    board.innerHTML = '';
    for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.className = 'game-cell';
        cell.style.width = '80px';
        cell.style.height = '80px';
        cell.onclick = () => playTTT(i);
        board.appendChild(cell);
    }
}

function playTTT(index) {
    if (tttBoard[index] || tttGameOver) return;
    
    tttBoard[index] = tttPlayer;
    const cells = document.getElementById('tttBoard').children;
    cells[index].textContent = tttPlayer;
    cells[index].style.color = tttPlayer === 'X' ? '#0000ff' : '#ff0000';
    
    if (checkTTTWin()) {
        document.getElementById('tttInfo').textContent = `${tttPlayer} wins!`;
        tttGameOver = true;
        return;
    }
    
    if (tttBoard.every(cell => cell)) {
        document.getElementById('tttInfo').textContent = 'Draw!';
        tttGameOver = true;
        return;
    }
    
    tttPlayer = tttPlayer === 'X' ? 'O' : 'X';
    document.getElementById('tttInfo').textContent = `${tttPlayer}'s turn`;
    
    if (tttPlayer === 'O') {
        setTimeout(aiTTT, 500);
    }
}

function aiTTT() {
    const empty = tttBoard.map((v, i) => v === '' ? i : null).filter(v => v !== null);
    if (empty.length > 0 && !tttGameOver) {
        const move = empty[Math.floor(Math.random() * empty.length)];
        playTTT(move);
    }
}

function checkTTTWin() {
    const wins = [
        [0,1,2], [3,4,5], [6,7,8],
        [0,3,6], [1,4,7], [2,5,8],
        [0,4,8], [2,4,6]
    ];
    return wins.some(combo => {
        return tttBoard[combo[0]] && 
               tttBoard[combo[0]] === tttBoard[combo[1]] && 
               tttBoard[combo[0]] === tttBoard[combo[2]];
    });
}

function resetTTT() {
    initTicTacToe();
}

// MINESWEEPER
let mineBoard = [];
let mineRevealed = [];
let mineFlagged = [];
let mineCount = 10;

function initMinesweeper() {
    mineBoard = Array(64).fill(0);
    mineRevealed = Array(64).fill(false);
    mineFlagged = Array(64).fill(false);
    
    let placed = 0;
    while (placed < mineCount) {
        const pos = Math.floor(Math.random() * 64);
        if (mineBoard[pos] !== -1) {
            mineBoard[pos] = -1;
            placed++;
        }
    }
    
    for (let i = 0; i < 64; i++) {
        if (mineBoard[i] !== -1) {
            let count = 0;
            const row = Math.floor(i / 8);
            const col = i % 8;
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const nr = row + dr;
                    const nc = col + dc;
                    if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                        const ni = nr * 8 + nc;
                        if (mineBoard[ni] === -1) count++;
                    }
                }
            }
            mineBoard[i] = count;
        }
    }
    
    const board = document.getElementById('mineBoard');
    board.innerHTML = '';
    for (let i = 0; i < 64; i++) {
        const cell = document.createElement('div');
        cell.className = 'game-cell';
        cell.style.width = '40px';
        cell.style.height = '40px';
        cell.onclick = () => revealMine(i);
        cell.oncontextmenu = (e) => {
            e.preventDefault();
            flagMine(i);
        };
        board.appendChild(cell);
    }
}

function revealMine(index) {
    if (mineRevealed[index] || mineFlagged[index]) return;
    
    mineRevealed[index] = true;
    const cells = document.getElementById('mineBoard').children;
    const cell = cells[index];
    
    if (mineBoard[index] === -1) {
        cell.textContent = '*';
        cell.style.background = '#ff0000';
        alert('Game Over!');
        for (let i = 0; i < 64; i++) {
            if (mineBoard[i] === -1) {
                cells[i].textContent = '*';
                cells[i].style.background = '#ff0000';
            }
        }
        return;
    }
    
    cell.style.background = '#ffffff';
    if (mineBoard[index] > 0) {
        cell.textContent = mineBoard[index];
    }
    
    if (mineBoard[index] === 0) {
        const row = Math.floor(index / 8);
        const col = index % 8;
        for (let dr = -1; dr <= 1; dr++) {
            for (let dc = -1; dc <= 1; dc++) {
                const nr = row + dr;
                const nc = col + dc;
                if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                    const ni = nr * 8 + nc;
                    if (!mineRevealed[ni]) {
                        revealMine(ni);
                    }
                }
            }
        }
    }
}

function flagMine(index) {
    if (mineRevealed[index]) return;
    
    mineFlagged[index] = !mineFlagged[index];
    const cells = document.getElementById('mineBoard').children;
    cells[index].textContent = mineFlagged[index] ? 'F' : '';
}

function resetMinesweeper() {
    initMinesweeper();
}

// SNAKE
let snake = [{x: 10, y: 10}];
let snakeDir = {x: 1, y: 0};
let snakeFood = {x: 15, y: 15};
let snakeScore = 0;
let snakeInterval;

function initSnake() {
    snake = [{x: 10, y: 10}];
    snakeDir = {x: 1, y: 0};
    snakeFood = {x: 15, y: 15};
    snakeScore = 0;
    document.getElementById('snakeInfo').textContent = 'Score: 0';
    
    if (snakeInterval) clearInterval(snakeInterval);
    snakeInterval = setInterval(updateSnake, 150);
    
    document.addEventListener('keydown', handleSnakeKey);
}

function handleSnakeKey(e) {
    switch(e.key) {
        case 'ArrowUp': if (snakeDir.y === 0) snakeDir = {x: 0, y: -1}; break;
        case 'ArrowDown': if (snakeDir.y === 0) snakeDir = {x: 0, y: 1}; break;
        case 'ArrowLeft': if (snakeDir.x === 0) snakeDir = {x: -1, y: 0}; break;
        case 'ArrowRight': if (snakeDir.x === 0) snakeDir = {x: 1, y: 0}; break;
    }
}

function updateSnake() {
    const head = {x: snake[0].x + snakeDir.x, y: snake[0].y + snakeDir.y};
    
    if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20 || 
        snake.some(s => s.x === head.x && s.y === head.y)) {
        clearInterval(snakeInterval);
        alert('Game Over! Score: ' + snakeScore);
        return;
    }
    
    snake.unshift(head);
    
    if (head.x === snakeFood.x && head.y === snakeFood.y) {
        snakeScore++;
        document.getElementById('snakeInfo').textContent = 'Score: ' + snakeScore;
        snakeFood = {
            x: Math.floor(Math.random() * 20),
            y: Math.floor(Math.random() * 20)
        };
    } else {
        snake.pop();
    }
    
    drawSnake();
}

function drawSnake() {
    const canvas = document.getElementById('snakeCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    ctx.fillStyle = '#c0c0c0';
    ctx.fillRect(0, 0, 400, 400);
    
    ctx.fillStyle = '#00ff00';
    snake.forEach(s => {
        ctx.fillRect(s.x * 20, s.y * 20, 18, 18);
    });
    
    ctx.fillStyle = '#ff0000';
    ctx.fillRect(snakeFood.x * 20, snakeFood.y * 20, 18, 18);
}

function resetSnake() {
    if (snakeInterval) clearInterval(snakeInterval);
    initSnake();
}

// ============================================================================
// APPS
// ============================================================================

// NOTEPAD
function downloadNotepad() {
    const text = document.getElementById('notepadText').value;
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'note.txt';
    a.click();
}

function clearNotepad() {
    if (confirm('Clear notepad?')) {
        document.getElementById('notepadText').value = '';
    }
}

// PAINT
let paintCanvas, paintCtx, paintColor = '#000000', isPainting = false;

window.addEventListener('load', () => {
    paintCanvas = document.getElementById('paintCanvas');
    paintCtx = paintCanvas.getContext('2d');
    
    paintCanvas.addEventListener('mousedown', (e) => {
        isPainting = true;
        paint(e);
    });
    
    paintCanvas.addEventListener('mousemove', (e) => {
        if (isPainting) paint(e);
    });
    
    paintCanvas.addEventListener('mouseup', () => {
        isPainting = false;
    });
});

function paint(e) {
    const rect = paintCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    paintCtx.fillStyle = paintColor;
    paintCtx.fillRect(x - 5, y - 5, 10, 10);
}

function setPaintColor(color) {
    paintColor = color;
}

function clearPaint() {
    if (confirm('Clear canvas?')) {
        paintCtx.fillStyle = '#ffffff';
        paintCtx.fillRect(0, 0, 660, 480);
    }
}

// CALCULATOR
let calcValue = '0';
let calcOperator = null;
let calcWaitingForOperand = false;

function calcInput(value) {
    if (calcWaitingForOperand) {
        calcValue = value;
        calcWaitingForOperand = false;
    } else {
        calcValue = calcValue === '0' ? value : calcValue + value;
    }
    document.getElementById('calcDisplay').value = calcValue;
}

function calcEquals() {
    try {
        calcValue = String(eval(calcValue));
        document.getElementById('calcDisplay').value = calcValue;
        calcWaitingForOperand = true;
    } catch(e) {
        calcValue = '0';
        document.getElementById('calcDisplay').value = 'Error';
    }
}

function calcClear() {
    calcValue = '0';
    calcOperator = null;
    calcWaitingForOperand = false;
    document.getElementById('calcDisplay').value = '0';
}

// SCREENSAVER
let screensaverInterval;

function startScreenSaver() {
    const ss = document.getElementById('screensaver');
    const text = document.getElementById('screensaverText');
    ss.classList.add('active');
    
    let x = Math.random() * (window.innerWidth - 200);
    let y = Math.random() * (window.innerHeight - 50);
    let dx = 2;
    let dy = 2;
    
    screensaverInterval = setInterval(() => {
        x += dx;
        y += dy;
        
        if (x <= 0 || x >= window.innerWidth - 200) dx = -dx;
        if (y <= 0 || y >= window.innerHeight - 50) dy = -dy;
        
        text.style.left = x + 'px';
        text.style.top = y + 'px';
    }, 20);
}

function stopScreenSaver() {
    clearInterval(screensaverInterval);
    document.getElementById('screensaver').classList.remove('active');
}

// ============================================================================
// SOCKET EVENTS
// ============================================================================

socket.on('connect', () => {
    console.log('[Connected]');
    document.getElementById('statusText').textContent = 'Connected';
});

socket.on('disconnect', () => {
    console.log('[Disconnected]');
    document.getElementById('statusText').textContent = 'Disconnected';
});

socket.on('chat-message', data => {
    addMessage(data.username, data.message, data.color, data.timestamp);
});

socket.on('image-message', data => {
    addImageMessage(data.username, data.imageData, data.color, data.timestamp);
});

socket.on('image-keyword', data => {
    addImageMessage(data.username, data.imageUrl, data.color, data.timestamp);
});

socket.on('system-message', data => {
    addSystemMessage(data.text);
});

socket.on('users-update', list => {
    users = list;
    updateUsersList();
});

socket.on('user-typing', data => {
    document.getElementById('typingIndicator').textContent = `${data.username} is typing...`;
});

socket.on('user-stop-typing', () => {
    document.getElementById('typingIndicator').textContent = '';
});

socket.on('achievement-unlocked', data => {
    showAchievement(data.title, data.description);
});

socket.on('win95-error', message => {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('win95Error').classList.add('show');
    setTimeout(closeWin95Error, 5000);
});

socket.on('clear-chat', () => {
    document.getElementById('messagesArea').innerHTML = '';
    addSystemMessage('Chat cleared.');
});

// FIX FOR BUG #2 and #3: Restore saved messages when room changes
socket.on('room-changed', room => {
    currentRoom = room;
    document.getElementById('currentRoom').textContent = room;
    document.getElementById('roomInfo').textContent = `Room: #${room}`;
    
    const messagesArea = document.getElementById('messagesArea');
    if (roomMessages[room]) {
        messagesArea.innerHTML = roomMessages[room];
    } else {
        messagesArea.innerHTML = '';
    }
    
    if (!roomMessages[room]) {
        addSystemMessage(`Joined room: #${room}`);
    }
    
    messagesArea.scrollTop = messagesArea.scrollHeight;
});

// FIX FOR BUG #1: Mark history messages so they don't trigger notifications
socket.on('message-history', messages => {
    if (!messages || messages.length === 0) return;
    
    messages.forEach(msg => {
        if (msg.message_type === 'normal') {
            addMessage(msg.username, msg.message, msg.color, msg.timestamp, true); // true = isHistory
        } else if (msg.message_type === 'image-upload') {
            addSystemMessage(`${msg.username} posted an image`);
        }
    });
    
    addSystemMessage('--- End of message history ---');
    
    const messagesArea = document.getElementById('messagesArea');
    roomMessages[currentRoom] = messagesArea.innerHTML;
});

socket.on('private-message', data => {
    showNotification(`PM from ${data.from}: ${data.message}`);
});

socket.on('message-blocked', message => {
    addErrorMessage(message);
});

socket.on('command-error', message => {
    addErrorMessage(message);
});

socket.on('login-error', message => {
    alert('Login Error: ' + message);
    openWindow('loginWindow');
    closeWindow('chatWindow');
});

// ============================================================================
// INPUT HANDLING
// ============================================================================

document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

document.getElementById('messageInput').addEventListener('input', () => {
    socket.emit('typing');
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        socket.emit('stop-typing');
    }, 1000);
});

// CLOCK
function updateClock() {
    const now = new Date();
    const hours = now.getHours() % 12 || 12;
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
    document.getElementById('clock').textContent = `${hours}:${minutes} ${ampm}`;
}
setInterval(updateClock, 1000);
updateClock();

// CLOSE MENUS ON CLICK
document.addEventListener('click', (e) => {
    if (!e.target.closest('.menu-item')) {
        closeAllDropdowns();
    }
    if (!e.target.closest('.start-menu') && !e.target.closest('.start-button')) {
        document.getElementById('startMenu').classList.remove('show');
    }
});

console.log('RetroChat95 v1.0 ULTIMATE - Loaded!');
</script>
</body>
</html>
